<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Architecture and Design - intel_fw</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">intel_fw</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/platform-system-interface/intel_fw" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="architecture-and-design"><a class="header" href="#architecture-and-design">Architecture and Design</a></h1>
<p>The following considerations around specifics in the domain of Intel platforms
and firmware are meant to offer a deeper understanding of design choices.</p>
<h2 id="goals"><a class="header" href="#goals">Goals</a></h2>
<h3 id="separate-detection-from-action"><a class="header" href="#separate-detection-from-action">Separate detection from action</a></h3>
<p><code>me_cleaner</code> mixes both, and assessing the exact actions to happen is hard.
Via its CLI, everything a one-shot operation, and the user needs to know the
options beforehand. Note that it is very Unixesque to wrap CLIs in shell scripts
as if they were intended as APIs. That is not meant here.</p>
<p>For programmatic and interactive use, provide an analysis result and let the
programmer/user <em>then</em> choose what they want to do. The programmer has to deal
with all possibilities and may choose strategies around them, whereas the user
can benefit from seeing the options fitting their actual case.</p>
<p>E.g., in a GUI app such as <a href="https://fiedka.app">Fiedka</a> or a TUI that could be
created with <a href="https://ratatui.rs/">ratatui</a>, setting a HAP bit vs legacy
(Alt)MeDisable bit(s) can be elaborated on in a help message or tooltip.
Removable partitions and files can be listed rather than expected to be provided
by the user who, before the analysis, doesn't know what their firmware contains.</p>
<h3 id="comprehensible-and-useful-api"><a class="header" href="#comprehensible-and-useful-api">Comprehensible and useful API</a></h3>
<p>Provide an API that requires little knowledge of internal details.
The job of an API is to simplify, after all. Otherwise, both caller and callee
would duplicate efforts.</p>
<p>Encapsulate rather than exposing many raw structs directly.
Make relationships and containment clear.</p>
<p>E.g., wrap partition entry structs in another struct that carries supporting
metadata with it, such as offset and size, parsing result of what the partition
entry points to, etc..</p>
<p>Follow the <a href="https://rust-lang.github.io/api-guidelines/">Rust API guidelines</a>.</p>
<h2 id="approaches"><a class="header" href="#approaches">Approaches</a></h2>
<p>Replies to a <a href="https://stackoverflow.com/questions/4355263/is-there-a-design-pattern-for-separating-preparation-of-work-from-execution">StackOverflow question on separating preparation from execution</a>
reference the <a href="https://en.wikipedia.org/wiki/Composite_pattern">Composite pattern</a>
and the <a href="https://rust-unofficial.github.io/patterns/patterns/behavioural/command.html">Command pattern</a>.</p>
<p>The Composite pattern helps in that there is a hierarchical structure, i.e.,
IFD, FIT and ME firmware on a high level, and then IFD has its underlying data,
the ME firmware has its FPT and partitions therein, and the FIT points to many
things. Underlying details are very different though, so there are no meaningful
abstractions for common interfaces.</p>
<p>The Command pattern may make sense on a higher level, for example, to collect
the actions resulting from command line switches or API options. At the same
time, it creates more boilerplate code, which may be hard to follow.</p>
<p>Note that we need to check the applicability of operations on two levels:
Some operations exclude others, and some only apply if their assumptions fit
with findings from analyzing the given firmware image.</p>
<p><a href="https://github.com/linuxboot/fiano">Fiano/utk</a> implements the <a href="https://rust-unofficial.github.io/patterns/patterns/behavioural/visitor.html">visitor pattern</a>,
which is meant for objects that are quite similar in some regard.</p>
<p>One issue with firmware images is that while many things are related to each
other, they also have their very specific purposes and semantics, and there is a
rather fixed structure. It would thus be simpler to <strong>deal with specific
operations on a higher level that understands the domain and carries clear
semantics</strong> with it rather than having a visitor/executor encoding each possible
operation for each bit and requiring more understanding from the user and
programmer.
I.e., just have <strong>each entity offer its own unique set of clearly understandable
helpers</strong> and assisting parameters, possibly following a loose pattern when
multiple entities are similar.</p>
<p>For example, some partitions contain directories in the case of generation 2 and
generation 3 ME:
For both generations, certain directories can be partially cleared (whole ranges
of data set to <code>0xff</code>), and both can take a list of things to retain.
That requires helpers which may implement a common trait (interface).
Similarly, other partitions can be cleared, but <em>entirely</em>, so they do not need
extra functionality themselves. Trying to force the same interface on them only
results in unnecessary extra code.</p>
<p>On the other hand, the FPT itself is a small memory slice (found to be &lt;2K), so
it can take care of itself. It has a checksum in its header. Offer helpers for
editing and returning a new slice to replace the original one.
The IFD is similar in that it is also small, but has its own unique features.
And the FIT is yet again very different.</p>
<p>See also the <a href="https://rust-unofficial.github.io/patterns/patterns/behavioural/strategy.html">strategy pattern</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="platforms.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="platforms.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
